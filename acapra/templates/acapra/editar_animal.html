{% extends 'acapra/base/base.html' %}
{% block title %}Editar Animal - {{ block.super }}{% endblock %}
{% block content %}
    {% load static %}
    <div class="max-w-4xl mx-auto">
        <br>
        <h1 class="text-3xl font-bold mb-6">Editar {{ animal.nome }}</h1>
        <form method="POST"
              enctype="multipart/form-data"
              class="bg-gray-800 p-6 rounded-lg shadow-md space-y-6">
            {% csrf_token %}
            {{ form.non_field_errors }}
            <div class="grid grid-cols-2 gap-4">
                <div>
                    {{ form.nome.label_tag }}
                    {{ form.nome }}
                </div>
                <div>
                    {{ form.especie.label_tag }}
                    {{ form.especie }}
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    {{ form.idade.label_tag }}
                    {{ form.idade }}
                </div>
                <div>
                    {{ form.porte.label_tag }}
                    {{ form.porte }}
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    {{ form.raca.label_tag }}
                    {{ form.raca }}
                </div>
                <div>
                    {{ form.vacina.label_tag }}
                    {{ form.vacina }}
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
    <div>{{ form.doenca.label_tag }}{{ form.doenca }}</div>
    <div id="descricao-container" class="{% if form.descricao.value %}block{% else %}hidden{% endif %}">
        {{ form.descricao }}
        {% if form.descricao.errors %}
            <ul class="text-red-500 text-sm">
            {% for error in form.descricao.errors %}
                <li>{{ error }}</li>
            {% endfor %}
            </ul>
        {% endif %}
    </div>
</div>
            <div>
                {{ form.observacao.label_tag }}
                {{ form.observacao }}
            </div>
            <div>
                {{ form.fotos.label_tag }}
                {{ form.fotos }}
            </div>
            <div class="flex items-center">
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                    Salvar Alterações
                </button>
                <form method="POST" action="{% url 'ExcluirAnimal' animal.id %}">
    {% csrf_token %}
    <button type="submit"
            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mt-4"
            onclick="return confirm('Tem certeza que deseja excluir este animal?');">
        Excluir Animal
    </button>
</form>
<a href="{% url 'DashboardAdmin' %}" class="ml-4 text-purple-400">Cancelar</a>
            </div>
        </form>
        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-4">Fotos existentes</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% for foto in animal.fotos.all %}
                    <div class="relative group">
                        <img src="{{ foto.imagem.url }}"
                             alt="Foto de {{ animal.nome }}"
                             class="w-full h-40 object-cover rounded-md mb-4" />
                        <form method="post"
                              action="{% url 'ExcluirFoto' foto.id %}"
                              class="absolute top-2 right-2">
                            {% csrf_token %}
                            <button type="submit"
                                    class="bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-700">
                            </button>
                        </form>
                    </div>
                {% empty %}
                    <p class="text-gray-400">Nenhuma foto cadastrada ainda.</p>
                {% endfor %}
            </div>
        </div>
    </div>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

    <style>
    .choices__list--dropdown .choices__item {
    color: #000 !important;
}

.hidden { display: none; }
.block { display: block; }

.choices__inner {
    color: #000 !important;    
    border-radius: 0.75rem !important;
}

.choices__input::placeholder {
    color: #888 !important;
}

.choices__item {
    border-radius: 0.5rem !important;
}
</style>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
document.addEventListener("DOMContentLoaded", function () {
    const racaField = document.getElementById("id_raca");
    const especieField = document.getElementById("id_especie");
    const vacinaSelect = document.getElementById("id_vacina");

    const vacinasPorEspecie = {
        "Gato": [
            {value: "V4", text: "V4"},
            {value: "Raiva", text: "Raiva"},
            {value: "Giárdia", text: "Giárdia"}
        ],
        "Cachorro": [
            {value: "V8", text: "V8"},
            {value: "V10", text: "V10"},
            {value: "Raiva", text: "Raiva"},
            {value: "Gripe", text: "Gripe"}
        ]
    };

    const choicesVacina = new Choices(vacinaSelect, {
        removeItemButton: true,
        placeholderValue: "Selecione as vacinas",
        searchEnabled: true,
    });

    function atualizarVacinas() {
    const especieSelecionada = especieField.value;
    const vacinasSelecionadas = choicesVacina.getValue(true) || [];
    choicesVacina.clearStore();
    if (vacinasPorEspecie[especieSelecionada]) {
        vacinasPorEspecie[especieSelecionada].forEach(v => {
            choicesVacina.setChoices([{
                value: v.value,
                label: v.text,
                selected: vacinasSelecionadas.includes(v.value),
                disabled: false
            }], 'value', 'label', false);
        });
    }
}

    especieField.addEventListener("change", atualizarVacinas);
    atualizarVacinas(); // atualiza ao carregar
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    const doencaField = document.getElementById("id_doenca");
    const descricaoContainer = document.getElementById("descricao-container");

    function toggleDescricao() {
        if (doencaField.value === "Sim") {
            descricaoContainer.style.display = "block";
        } else {
            descricaoContainer.style.display = "none";
            document.getElementById("id_descricao").value = "";
        }
    }

    toggleDescricao();
    doencaField.addEventListener("change", toggleDescricao);
});
</script>



{% endblock %}
